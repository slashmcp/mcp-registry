// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Job status enum
enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Model Context Protocol (MCP) Service Registry
model Service {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  url         String   @unique
  version     String   @default("v0.1")
  owner       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// MCP Server Registry Entry (enhanced version for MCP v0.1 spec)
model McpServer {
  id              String   @id @default(cuid())
  serverId        String   @unique // e.g., "io.github.mcpmessenger/mcp-server"
  name            String
  description     String?
  version         String   @default("v0.1")
  command         String?  // Execution command
  args            String?  // JSON array of arguments
  env             String?  // JSON object of environment variables
  manifest        String?  // JSON string of full MCP manifest
  capabilities    String?  // JSON array of capabilities
  tools           String?  // JSON array of tool definitions (pre-validated schemas)
  toolSchemas     String?  // JSON object mapping tool names to full JSON schemas for validation
  isActive        Boolean  @default(true)
  isPublic        Boolean  @default(true) // Public registry vs private sub-registry
  federationId    String?  // For private sub-registries
  federation      Federation? @relation(fields: [federationId], references: [id])
  publishedBy     String?  // User/owner who published this server
  publishedAt     DateTime @default(now())
  metadata        String?  // JSON string for additional metadata
  authConfig      String?  // JSON: OAuth2 configuration for third-party servers
  encryptedTokens String?  // Encrypted OAuth tokens (encrypted at rest)
  tokenExpiresAt  DateTime? // Token expiration
  // Workflow state machine fields
  workflowState   String?  // Current workflow state (e.g., "VisionAnalyzing", "ResearcherQueued", "Completed")
  lockedBy        String?  // Agent/server currently processing this workflow
  workflowAttempts Int     @default(0) // Number of retry attempts
  contextId       String?  // Link to conversation/memory for this workflow
  workflowUpdatedAt DateTime? // Last workflow state update
  // Server Identity (SEP-1302) fields
  identityPublicKey String? // Public key from /.well-known/mcp-server-identity
  identitySignature String? // Cryptographic signature from identity endpoint
  identityVerified Boolean @default(false) // Whether identity has been verified
  identityVerifiedAt DateTime? // When identity was last verified
  identityUrl String? // URL where identity endpoint was found
  // Trust Scoring fields
  securityScore Int? // Security score 0-100 (higher is better)
  lastSecurityScan DateTime? // Last time security scan was run
  securityScanResults String? // JSON string of scan results (npm audit, code analysis, etc.)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  designJobs      DesignJob[]
  durableTasks    DurableTask[]
  
  @@index([serverId])
  @@index([isActive])
  @@index([isPublic])
  @@index([federationId])
  @@index([publishedBy])
}

// Design Job for tracking SVG generation requests
model DesignJob {
  id              String    @id @default(cuid())
  status          JobStatus @default(PENDING)
  description     String    // Natural language description
  refinementNotes String?   // Iterative refinement instructions
  progress        Int       @default(0) // 0-100 percentage
  progressMessage String?   // Current status message
  errorMessage    String?   // Error details if failed
  serverId        String?   // Associated MCP server
  server          McpServer? @relation(fields: [serverId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?
  
  // Relations
  assets          Asset[]
  
  @@index([status])
  @@index([createdAt])
  @@index([serverId])
}

// Durable Task for tracking long-running async operations across MCP servers (SEP-1686)
model DurableTask {
  id              String    @id @default(cuid())
  taskId          String    @unique // External task ID from MCP server
  serverId        String    // Which MCP server owns this task
  server          McpServer @relation(fields: [serverId], references: [id])
  status          JobStatus @default(PENDING)
  taskType        String?   // Type of task (e.g., "data-processing", "model-training", "analysis")
  description     String?   // Human-readable description
  input           String?   // JSON string of task input parameters
  output          String?   // JSON string of task output/result
  progress        Int       @default(0) // 0-100 percentage
  progressMessage String?   // Current status message
  errorMessage    String?   // Error details if failed
  metadata        String?   // JSON string for additional metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?
  
  @@index([serverId])
  @@index([status])
  @@index([taskId])
  @@index([createdAt])
}

// Generated assets (SVGs, images, etc.)
model Asset {
  id              String    @id @default(cuid())
  jobId           String
  job             DesignJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  assetType       String    // "svg", "png", "jpg", etc.
  content         String?   // SVG content or file path
  filePath        String?   // Path to stored file
  url             String?   // Public URL if hosted
  version         Int       @default(1) // For tracking iterations
  isLatest        Boolean   @default(true)
  metadata        String?   // JSON string for additional metadata
  createdAt       DateTime  @default(now())
  
  @@index([jobId])
  @@index([isLatest])
}

// Registry Federation - for private sub-registries
model Federation {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String?
  organizationId  String   @unique // Organization identifier
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  servers         McpServer[]
  
  @@index([organizationId])
  @@index([isActive])
}

// OAuth 2.1 Client Registry
model OAuthClient {
  id                String   @id @default(cuid())
  clientId          String   @unique
  clientSecret      String   // Hashed
  clientName        String
  redirectUris      String   // JSON array of allowed redirect URIs
  scopes            String   // JSON array of allowed scopes
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  consents          OAuthConsent[]
  
  @@index([clientId])
  @@index([isActive])
}

// OAuth 2.1 Consent Storage - per-client, per-user consent tracking
model OAuthConsent {
  id                String   @id @default(cuid())
  clientId          String
  client            OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId            String   // User identifier
  scopes            String   // JSON array of consented scopes
  grantedAt         DateTime @default(now())
  expiresAt         DateTime? // Optional expiration
  revokedAt         DateTime? // Revocation timestamp
  isActive          Boolean  @default(true)
  
  @@unique([clientId, userId])
  @@index([userId])
  @@index([clientId])
  @@index([isActive])
}

// Conversation and Agent Memory
model Conversation {
  id              String   @id @default(cuid())
  userId          String?  // Optional: for user-specific conversations
  title           String?   // Auto-generated or user-provided title
  systemPrompt    String?   // System instructions for the agent
  context         String?   // JSON string for conversation context/metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  messages        Message[]
  toolInvocations ToolInvocation[]
  memories        Memory[]
  
  @@index([userId])
  @@index([createdAt])
}

// Chat messages in a conversation
model Message {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role            String   // "user", "assistant", "system", "tool"
  content         String   // Message content
  toolCalls       String?  // JSON array of tool calls made by assistant
  toolResults     String?  // JSON array of tool results
  metadata        String?  // JSON string for additional metadata (attachments, etc.)
  createdAt       DateTime  @default(now())
  
  @@index([conversationId])
  @@index([createdAt])
}

// Tool invocations across servers
model ToolInvocation {
  id              String   @id @default(cuid())
  conversationId  String?
  conversation    Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  serverId        String   // Which MCP server was used
  toolName        String   // Tool that was invoked
  arguments       String   // JSON string of arguments
  result          String?  // JSON string of result
  error           String?  // Error message if failed
  latency         Int?     // Response time in milliseconds
  createdAt       DateTime  @default(now())
  
  @@index([conversationId])
  @@index([serverId])
  @@index([createdAt])
}

// Agent Memory - long-term context and learned information
model Memory {
  id              String   @id @default(cuid())
  conversationId  String?
  conversation    Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  userId          String?  // User-specific memories
  type            String   // "fact", "preference", "instruction", "context"
  key             String   // Memory key/identifier
  value           String   // Memory value/content (can be JSON)
  importance      Int      @default(1) // 1-10, higher = more important
  accessCount     Int      @default(0) // How many times this memory was accessed
  lastAccessed    DateTime @default(now())
  expiresAt       DateTime? // Optional expiration
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([conversationId])
  @@index([userId])
  @@index([type])
  @@index([key])
  @@index([importance])
}
